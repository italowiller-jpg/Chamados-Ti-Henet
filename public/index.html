<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>He_Net ‚Äî Central de Suporte</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="/styles.css"/>
  <style>
    :root{
      --bg: #f5f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --border: #e6eaef;
      --accent: #0b67ff;
      --radius:10px;
    }

    body{ margin:0; font-family: Inter, system-ui, Arial, sans-serif; background:linear-gradient(#f8fbff,#f5f8fb); color:#0b1724; }
    .header{ display:flex; justify-content:space-between; align-items:center; padding:12px 20px; box-shadow:0 3px 18px rgba(11,20,40,0.04); background:transparent; position:sticky; top:0; z-index:20; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo img{ width:44px; height:44px; border-radius:8px; object-fit:cover; display:block; }
    .text strong{ display:block; font-size:16px; }
    .text .small{ color:var(--muted); font-size:12px; margin-top:-4px; }

    .actions{ display:flex; gap:8px; align-items:center; }
    .btn{ padding:8px 12px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; box-shadow: 0 6px 18px rgba(11,103,255,0.08); }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(11,103,255,0.08); box-shadow:none; }
    .btn.secondary{ background:#f1f5f9; color:#0b1724; border:1px solid var(--border); }
    .btn.outline{ background:transparent; border:1px solid var(--border); color:#0b1724; }

    main { padding:26px 18px; }
    .container { max-width:1280px; margin:0 auto; }

    /* Hero */
    .hero-area{ padding:6px 0 18px 0; display:flex; gap:24px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .hero-left h1{ margin:18px 0 6px; font-size:28px; color:#08304a; }
    .lead{ color:var(--muted); max-width:980px; }

    /* Dashboard grid */
    #dashboard{ display:none; margin-top:10px; }
    .dashboard-grid { display:grid; grid-template-columns: 420px 1fr; gap:24px; align-items:start; }

    .left-col { display:flex; flex-direction:column; gap:14px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(10,20,40,0.03); }
    .tickets-top{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    select.input{ padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#fff; min-width:140px; }

    .tickets-list-wrap{ background:transparent; padding-top:8px; }
    #ticketsList{ max-height: calc(78vh - 200px); overflow:auto; display:flex; flex-direction:column; gap:10px; padding-right:6px; }

    .ticket-item{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; background:#fff; padding:12px; border-radius:8px; border-left:4px solid transparent; box-shadow: 0 1px 3px rgba(10,20,40,0.03); cursor:pointer; transition:transform .08s ease, box-shadow .12s ease; }
    .ticket-item:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(8,20,40,0.05); }
    .ticket-item.selected{ border-left-color:var(--accent); background:linear-gradient(90deg,#ffffff,#f6fbff); }

    .ticket-meta{ flex:1; min-width:0; display:flex; flex-direction:column; gap:6px; }
    .ticket-meta .title{ font-weight:600; font-size:15px; color:#072033; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ticket-meta .sub{ font-size:12px; color:var(--muted); }

    .status-badge{ font-size:12px; padding:6px 8px; border-radius:12px; font-weight:600; min-width:84px; text-align:center; }
    .status-new{ background:#eff6ff; color:#0b67ff; border:1px solid rgba(11,103,255,0.08); }
    .status-progress{ background:#fff7ed; color:#ff8a00; border:1px solid rgba(255,138,0,0.08); }
    .status-done{ background:#f0fdf4; color:#059669; border:1px solid rgba(5,150,105,0.06); }
    .status-closed{ background:#f3f4f6; color:#6b7280; border:1px solid rgba(99,102,106,0.04); }

    .right-col { display:flex; flex-direction:column; gap:14px; }
    .ticket-detail{ min-height:320px; max-height: calc(78vh - 160px); overflow:auto; padding:14px; border-radius:8px; border:1px solid var(--border); background:var(--card); }

    .form-row{ margin-bottom:12px; }

    @media (max-width:1150px){ .dashboard-grid{ grid-template-columns: 360px 1fr; } }
    @media (max-width:900px){ .dashboard-grid{ grid-template-columns: 1fr; } #ticketsList{ max-height: 260px; } .ticket-detail{ max-height: 360px; } .hero-area{ flex-direction:column; } }

    .small{ font-size:13px; color:var(--muted); }
    .muted{ color:var(--muted); }
    .pwd-toggle { cursor:pointer; display:inline-flex; align-items:center; gap:8px; }
    /* small helpers for links */
    .linkish { background:transparent; border:none; color:var(--accent); cursor:pointer; padding:0; font:inherit; text-decoration:underline; }
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">
        <img src="/logo.png" alt="logo" style="width:100%;height:100%;object-fit:cover">
      </div>
      <div class="text">
        <strong id="siteTitle">He_Net</strong>
        <div class="small" id="siteSubtitle">Central de Suporte</div>
      </div>
    </div>

    <div class="actions">
      <button id="toSubmit" class="btn">Abrir Chamado</button>
      <button id="openAdmin" class="btn ghost" style="display:none" title="Abrir painel SuperADM">Admin</button>
      <button id="openReports" class="btn ghost" style="display:none" title="Relat√≥rios T√©cnicos">Relat√≥rios</button>
      <button id="logoutBtn" class="btn secondary" style="display:none">Sair</button>
      <button id="loginBtn" class="btn outline">Entrar</button>
    </div>
  </div>

  <main>
    <div class="container">

      <!-- CART√ÉO PRINCIPAL - LOGIN -->
      <section id="hero" class="hero-area">
        <div class="hero-left" style="flex:1;min-width:260px">
          <h1>Bem-vindo √† <strong>He_Net</strong></h1>
          <p class="lead">Central de suporte para sua equipe ‚Äî abra, acompanhe e resolva chamados com efici√™ncia. Atribua t√©cnicos, registre coment√°rios e acompanhe o hist√≥rico dos atendimentos.</p>
        </div>

        <div class="hero-right" style="margin-top:12px">
          <div id="loginCard" class="card login-card" style="max-width:480px">
            <h3>Acessar o Painel</h3>

            <form id="loginForm" class="form-vertical" onsubmit="return false;">
              <label class="label">E-mail</label>
              <input id="email" class="input" type="email" placeholder="seu@email.com" autocomplete="username" required style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">

              <label class="label" style="margin-top:10px">Senha</label>
              <div style="position:relative">
                <input id="password" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">
                <button type="button" id="togglePwd" class="btn ghost pwd-toggle" title="Mostrar/ocultar senha" style="position:absolute; right:8px; top:8px; height:36px; padding:6px 8px">üëÅÔ∏è</button>
              </div>

              <div class="form-row" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
                <label style="display:flex;align-items:center;gap:8px;font-size:14px">
                  <input id="rememberMe" type="checkbox" style="width:16px;height:16px;margin:0"> Manter conectado
                </label>
                <button id="forgotBtn" class="linkish" type="button">Esqueci a senha</button>
              </div>

              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="loginBtnInline" class="btn" type="button">Entrar</button>
                <button id="openPublic" class="btn ghost" type="button">Abrir chamado</button>
              </div>

              <div id="loginResult" class="small" style="margin-top:10px;color:#c00;min-height:18px"></div>

            </form>

            <div style="margin-top:12px">
              <div style="display:flex;align-items:center;justify-content:space-between">
                <div class="small muted">Ainda n√£o tem conta?</div>
                <button id="showRegisterBtn" class="btn ghost" style="padding:6px 10px">Criar conta</button>
              </div>
            </div>

            <div class="small muted" style="margin-top:10px">
              Use sua conta interna para gerenciar chamados. Para clientes, use o bot√£o <strong>Abrir chamado</strong> para enviar solicita√ß√µes p√∫blicas.
            </div>
          </div>

          <!-- REGISTER CARD (hidden by default) -->
          <div id="registerCard" class="card" style="max-width:480px; margin-top:12px; display:none">
            <h3>Criar Conta ‚Äî Operador</h3>
            <form id="registerForm" onsubmit="return false;">
              <label class="label">Nome completo</label>
              <input id="regName" class="input" type="text" placeholder="Seu nome" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">

              <label class="label" style="margin-top:10px">E-mail</label>
              <input id="regEmail" class="input" type="email" placeholder="seu@email.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">

              <label class="label" style="margin-top:10px">Senha</label>
              <input id="regPassword" class="input" type="password" placeholder="Senha (m√≠n. 6 chars)" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">

              <label class="label" style="margin-top:10px">Confirmar senha</label>
              <input id="regPassword2" class="input" type="password" placeholder="Repita a senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border)">

              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="registerSubmit" class="btn" type="button">Enviar registro</button>
                <button id="cancelRegister" class="btn ghost" type="button">Cancelar</button>
              </div>

              <div id="registerResult" class="small" style="margin-top:10px;min-height:18px"></div>

              <div class="small muted" style="margin-top:8px">
                O cadastro ser√° criado como <strong>Operador</strong> e ficar√° pendente de aprova√ß√£o do administrador. Voc√™ ser√° notificado por e-mail quando aprovado.
              </div>
            </form>
          </div>

        </div>
      </section>

      <!-- DASHBOARD -->
      <section id="dashboard">
        <div class="dashboard-grid">
          <!-- LEFT: lista -->
          <div class="left-col">
            <div class="card tickets-card">
              <div class="tickets-top">
                <div style="font-weight:600">Chamados</div>
                <div style="display:flex;gap:8px;align-items:center">
                  <select id="filterStatus" class="input">
                    <option value="">Todos</option>
                    <option value="new">Novo</option>
                    <option value="in_progress">Em andamento</option>
                    <option value="resolved">Conclu√≠do</option>
                    <option value="closed">Fechado</option>
                  </select>
                  <button id="refreshBtn" class="btn secondary">Atualizar</button>
                </div>
              </div>

              <div class="tickets-list-wrap">
                <div id="ticketsList">
                  <!-- exemplo est√°tico ‚Äî o app.js carregar√° dinamicamente -->
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT: detalhe -->
          <div class="right-col">
            <div class="card">
              <h4 style="margin:0 0 10px;">Detalhes do chamado</h4>
              <div id="ticketDetail" class="ticket-detail">
                Selecione um chamado √† esquerda para ver detalhes.
              </div>
            </div>

            <div class="card">
              <h4 style="margin:0 0 10px;">Atividades</h4>
              <div class="small muted">Nenhuma atividade selecionada.</div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="footer" style="padding:18px 0;text-align:center;color:var(--muted)">He_Net ‚Äî Central de Suporte</footer>

  <!-- seu app.js (se existir) e checagem admin -->
  <script src="/app.js"></script>
  <script src="/admin-check.js"></script>

  <!-- Script local: garante que os bot√µes e formul√°rios funcionem mesmo se app.js n√£o registrar listeners -->
  <script>
    (function(){
      // --- Helpers fetch ---
      async function postJSON(url, body) {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), credentials: 'include' });
        const text = await res.text();
        try { return { ok: res.ok, status: res.status, body: text ? JSON.parse(text) : null }; } catch(e) { return { ok: res.ok, status: res.status, body: text }; }
      }

      // preenche campos de remember
      try {
        const stored = localStorage.getItem('henet_remember');
        if (stored) {
          const o = JSON.parse(stored);
          if (o && o.email) document.getElementById('email').value = o.email;
          if (o && o.remember) document.getElementById('rememberMe').checked = true;
        }
      } catch(e){}

      // toggle senha
      const pwd = document.getElementById('password');
      const toggleBtn = document.getElementById('togglePwd');
      toggleBtn?.addEventListener('click', () => {
        if (!pwd) return;
        if (pwd.type === 'password') { pwd.type = 'text'; toggleBtn.textContent = 'üôà'; }
        else { pwd.type = 'password'; toggleBtn.textContent = 'üëÅÔ∏è'; }
      });

      // NAV buttons (safe inline wiring)
      document.getElementById('toSubmit')?.addEventListener('click', ()=> { window.location.href = '/submit'; });
      document.getElementById('openPublic')?.addEventListener('click', ()=> { window.location.href = '/submit'; });
      document.getElementById('openAdmin')?.addEventListener('click', ()=> { window.location.href = '/admin'; });
      document.getElementById('openReports')?.addEventListener('click', ()=> { window.location.href = '/superadmin-reports'; });

      // show register card
      document.getElementById('showRegisterBtn')?.addEventListener('click', ()=>{
        document.getElementById('registerCard').style.display = 'block';
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('registerResult').innerText = '';
      });
      document.getElementById('cancelRegister')?.addEventListener('click', ()=>{
        document.getElementById('registerCard').style.display = 'none';
        document.getElementById('loginCard').style.display = 'block';
      });

      // login handler
      async function doLogin() {
        const email = (document.getElementById('email')?.value || '').trim();
        const password = document.getElementById('password')?.value || '';
        const out = document.getElementById('loginResult');
        if (!email || !password) { if (out) out.innerText = 'Preencha email e senha'; return; }
        if (out) { out.innerText = 'Aguarde...'; out.style.color = '#333'; }

        try {
          const r = await postJSON('/api/login', { email, password });
          if (r.ok) {
            // salvar remember
            const remember = document.getElementById('rememberMe')?.checked;
            if (remember) localStorage.setItem('henet_remember', JSON.stringify({ email, remember: true }));
            else localStorage.removeItem('henet_remember');

            // atualizar UI: delega para app.js se tiver fun√ß√£o checkMe, caso contr√°rio recarrega
            if (typeof window.checkMe === 'function') {
              try { await window.checkMe(); } catch(e){}
            }
            location.reload();
          } else {
            if (r.status === 403 && r.body && r.body.error === 'awaiting_approval') {
              if (out) { out.style.color = '#c00'; out.innerText = 'Conta pendente de aprova√ß√£o pelo administrador.'; }
            } else {
              if (out) { out.style.color = '#c00'; out.innerText = (r.body && (r.body.error || r.body.message)) || 'Erro ao autenticar'; }
            }
          }
        } catch (e) {
          if (out) { out.style.color = '#c00'; out.innerText = 'Erro de rede'; }
          console.error('login err', e);
        }
      }

      document.getElementById('loginBtnInline')?.addEventListener('click', doLogin);

      // register handler
      document.getElementById('registerSubmit')?.addEventListener('click', async () => {
        const name = (document.getElementById('regName')?.value || '').trim();
        const email = (document.getElementById('regEmail')?.value || '').trim();
        const pass = document.getElementById('regPassword')?.value || '';
        const pass2 = document.getElementById('regPassword2')?.value || '';
        const out = document.getElementById('registerResult');

        if (!name || !email || !pass) { if (out) { out.style.color='#c00'; out.innerText = 'Preencha todos os campos'; } return; }
        if (pass.length < 6) { if (out) { out.style.color='#c00'; out.innerText = 'Senha muito curta (min 6)'; } return; }
        if (pass !== pass2) { if (out) { out.style.color='#c00'; out.innerText = 'Senhas n√£o coincidem'; } return; }

        try {
          const r = await postJSON('/api/register', { name, email, password: pass });
          if (r.ok) {
            if (out) { out.style.color='#059669'; out.innerText = r.body && r.body.message ? r.body.message : 'Cadastro enviado. Aguarde aprova√ß√£o do administrador.'; }
            // limpar
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPassword2').value = '';
            // manter o usu√°rio na tela de login (ou voltar)
            setTimeout(()=> {
              document.getElementById('registerCard').style.display = 'none';
              document.getElementById('loginCard').style.display = 'block';
            }, 1000);
          } else {
            if (out) { out.style.color='#c00'; out.innerText = (r.body && (r.body.error || r.body.message)) || 'Erro ao registrar'; }
          }
        } catch (e) {
          if (out) { out.style.color='#c00'; out.innerText = 'Erro de rede'; }
          console.error('register err', e);
        }
      });

      // logout button (front-end trigger)
      document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        try {
          await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        } catch(e){}
        location.reload();
      });

      // If page has ?awaiting=1 show friendly message
      try {
        const qs = new URLSearchParams(location.search);
        if (qs.get('awaiting') === '1') {
          const rr = document.getElementById('registerResult');
          if (rr) { rr.style.color = '#059669'; rr.innerText = 'Registro recebido ‚Äî sua conta aguarda aprova√ß√£o do administrador.'; }
          // remove param visually
          try { const url = new URL(location.href); url.searchParams.delete('awaiting'); history.replaceState(null, '', url.pathname + url.search); } catch(e){}
        }
      } catch(e){}

      // expose a small helper to app.js if it wants to call checkMe
      window.frontendHelpers = { doLogin };

    })();
  </script>
</body>
</html>
